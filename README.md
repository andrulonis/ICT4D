# AgriSpeak

The backend for the AgriSpeak forecast voice application.

## Features

AgriSpeak allows users to call a phone number and receive rainfall forecast information. The following features are supported:
- [x] 24 hour rainfall forecast
- [x] Information about the previous day's rainfall 
- [x] Estimated remaining duration of current rainfall
- [x] Multiple languages
- [ ] User feedback system

## System architecture

TODO: @Daanvduin

## Prerequisites

You will need:
- A weatherapi.com account with a generated API key.
- An Amazon S3, Cloudflare R2 or similar file storage solution.
- A running PostgreSQL instance.

## Deploy

### One click Vercel deployment

Click here to deploy with Vercel:

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fandrulonis%2FICT4D)

The service will is accessible at the domain name generated by Vercel. This domain name is the `<host>` field in the [usage section](#usage).

**Note:** The app will not work right away. Please go to the project settings, add the environment variables according to the table in the [environment variables](#environment-variables) section **and redeploy**.

### Manual

#### Dependencies

First, create a virtual environment using the command below:

```sh
python3 -m venv .venv
```

Then activate it:

```sh
. .venv/bin/activate
```

Install the required dependencies into the virtual environment:

```sh
pip3 install -r requirements.txt
```

#### Enter environment variables

The application requires multiple environment variables to be set in order to function properly. Make a copy of `.env.template` and name it `.env`. Add the required values where required. The table in the [environment variables](#environment-variables) section explains what the values mean. All values are required.

#### Run

The below command will run the server on the default port and IP.

```
python3 manage.py runserver
```

## Usage

The API exposes one endpoint at the root URL that returns the VXML file. To view it, make a GET request to `http://<host>:<port>/`. This will redirect you to the English version of the service. 

**Other languages**

Navigate to `http://<host>:<port>/<lang>` to retrieve the VXML file in other languages, where `<lang>` is the requested language. Please consult the below table for which value to use in place of `<lang>`:

|Language|`<lang>`|
|--------|--------|
|English (default)|`en`|
|French|`fr`| 

## Environment variables

The below table explains what the environment variable values mean. All are required.

|Environment variable|Description|
|--------------------|-----------|
| `WEATHER_API_KEY`           | weatherapi.com API key. Make an account and provide the API key here |
| `SECRET_KEY`                | Used by Django for security purposes. Can be anything, as long as it is kept secret. |
| `AWS_STORAGE_BUCKET_NAME`   | The name of your AWS S3 bucket. Cloudflare R2 is also supported. |
| `AWS_S3_ENDPOINT_URL`       | The URL of the bucket, provided by S3/R2. |
| `AWS_S3_ACCESS_KEY_ID`      |  The ID of the access key, provided by S3/R2. |
| `AWS_S3_SECRET_ACCESS_KEY`  | The access key for the bucket, be sure to keep this a secret. Provided by S3/R2. |
| `POSTGRES_DB`               | This project assumes there already exists a running postgres database somewhere, provide the name of the database here. |
| `POSTRGRES_USER`            | The username of a postgres user. |
| `POSTGRES_PASSWORD`         | The password of the above user. Be sure to keep this secret. |
| `POSTGRES_HOST`             | The hostname of the connection to the database. If hosted locally this will be `localhost` or similar. |
| `POSTGRES_PORT`             | The port of the connection to the database. |

